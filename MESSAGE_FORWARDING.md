# è¨Šæ¯è½‰ç™¼æ©Ÿåˆ¶èªªæ˜ (Message Forwarding Mechanism)

## ç³»çµ±æ¦‚è¦½ (System Overview)

é€™å€‹ reactive broker ä½¿ç”¨é›™ goroutine æ¶æ§‹ä¾†è™•ç†è¨Šæ¯è½‰ç™¼ï¼š
- **Proxy Goroutine**: è™•ç†æ‰€æœ‰ç¶²è·¯ I/Oï¼ˆæ¥å—é€£ç·šã€è®€å–è³‡æ–™ï¼‰
- **Application Logic Goroutine**: è™•ç†æ¥­å‹™é‚è¼¯ï¼ˆè¨‚é–±ç®¡ç†ã€è¨Šæ¯è·¯ç”±ï¼‰

## è¨Šæ¯è½‰ç™¼æµç¨‹åœ– (Message Forwarding Flow)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Publisher 1 â”‚          â”‚ Publisher 2 â”‚          â”‚ Publisher 3 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                        â”‚
       â”‚ PUBLISH|sports|âš½      â”‚ PUBLISH|tech|ğŸ’»        â”‚ PUBLISH|sports|ğŸ€
       â”‚                        â”‚                        â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚    BROKER (Port 8080)         â”‚
                â”‚                               â”‚
                â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                â”‚  â”‚   Proxy Goroutine       â”‚  â”‚ â—„â”€â”€â”€ Accepts connections
                â”‚  â”‚   - Accept connections  â”‚  â”‚ â—„â”€â”€â”€ Reads from all clients
                â”‚  â”‚   - Read from clients   â”‚  â”‚ â—„â”€â”€â”€ Non-blocking polling
                â”‚  â”‚   - Parse packets       â”‚  â”‚
                â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                â”‚              â”‚                 â”‚
                â”‚              â”‚ packets chan    â”‚
                â”‚              â–¼                 â”‚
                â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                â”‚  â”‚ Application Logic       â”‚  â”‚ â—„â”€â”€â”€ Single-threaded
                â”‚  â”‚   - Route SUBSCRIBE     â”‚  â”‚ â—„â”€â”€â”€ Manages subscriptions
                â”‚  â”‚   - Route PUBLISH       â”‚  â”‚ â—„â”€â”€â”€ Forwards messages
                â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚               â”‚               â”‚
               â–¼               â–¼               â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚Subscriber A â”‚ â”‚Subscriber B â”‚ â”‚Subscriber C â”‚
       â”‚(sports)     â”‚ â”‚(tech)       â”‚ â”‚(sports)     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            âš½ğŸ€              ğŸ’»              âš½ğŸ€
```

## ç¨‹å¼å‘¼å«è·¯å¾‘ (Program Call Path for Message Forwarding)

### å®Œæ•´çš„è¨Šæ¯è½‰ç™¼æµç¨‹ (Complete Message Flow):

```
1. Publisher é€£ç·šä¸¦ç™¼é€è¨Šæ¯
   Publisher connects â†’ net.Dial("tcp", "localhost:8080")
   Publisher sends    â†’ conn.Write("PUBLISH|sports|Goal!\n")

2. Proxy Goroutine æ¥æ”¶è¨Šæ¯
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ proxy()                                             â”‚
   â”‚  â”œâ”€ listener.Accept()              [æ–°é€£ç·š]         â”‚
   â”‚  â”œâ”€ bufio.NewReader(conn)          [å»ºç«‹ reader]    â”‚
   â”‚  â”œâ”€ reader.ReadString('\n')        [è®€å–è³‡æ–™]       â”‚
   â”‚  â”œâ”€ parsePacket(text, conn)        [è§£æå°åŒ…]       â”‚
   â”‚  â”‚   â””â”€ å›å‚³ Packet{                               â”‚
   â”‚  â”‚        controlType: PUBLISH                      â”‚
   â”‚  â”‚        topic: "sports"                           â”‚
   â”‚  â”‚        payload: "Goal!"                          â”‚
   â”‚  â”‚        conn: <publisher-conn>                    â”‚
   â”‚  â”‚      }                                           â”‚
   â”‚  â””â”€ b.packets <- packet             [é€å…¥ channel]  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ Channel å‚³é
                         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ applicationLogic()                                  â”‚
   â”‚  â”œâ”€ packet := <-b.packets          [æ¥æ”¶å°åŒ…]       â”‚
   â”‚  â”œâ”€ switch packet.controlType                       â”‚
   â”‚  â””â”€ case PUBLISH:                                   â”‚
   â”‚      â””â”€ handlePublish(packet)      [è™•ç†ç™¼å¸ƒ]       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ handlePublish(packet)                               â”‚
   â”‚  â”œâ”€ b.subscriberMu.Lock()          [é–å®šè¨‚é–±è€…]     â”‚
   â”‚  â”œâ”€ subscribers := b.subscribers[packet.topic]      â”‚
   â”‚  â”‚   â””â”€ å–å¾— topic "sports" çš„æ‰€æœ‰è¨‚é–±è€…             â”‚
   â”‚  â”œâ”€ b.subscriberMu.Unlock()        [è§£é–]          â”‚
   â”‚  â”‚                                                   â”‚
   â”‚  â”œâ”€ for _, conn := range subscribers                â”‚
   â”‚  â”‚   â”œâ”€ message := "Goal!\n"                        â”‚
   â”‚  â”‚   â””â”€ conn.Write([]byte(message)) [è½‰ç™¼çµ¦è¨‚é–±è€…]  â”‚
   â”‚  â”‚                                                   â”‚
   â”‚  â””â”€ packet.conn.Close()             [é—œé–‰ç™¼å¸ƒè€…]    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ ç¶²è·¯å‚³è¼¸
                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Subscribers      â”‚
              â”‚  æ”¶åˆ°è¨Šæ¯: "Goal!" â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. Subscriber æ¥æ”¶è¨Šæ¯
   Subscriber reads   â†’ scanner.Scan()
   Subscriber prints  â†’ fmt.Printf("Received: %s\n", message)
```

## é—œéµè³‡æ–™çµæ§‹ (Key Data Structures)

```go
// Packet - åœ¨ goroutines é–“å‚³éçš„è³‡æ–™çµæ§‹
type Packet struct {
    conn        net.Conn    // ç™¼é€è€…çš„é€£ç·š
    controlType PacketType  // PUBLISH æˆ– SUBSCRIBE
    topic       string      // ä¸»é¡Œåç¨±
    payload     string      // è¨Šæ¯å…§å®¹
}

// Broker - æ ¸å¿ƒè³‡æ–™çµæ§‹
type Broker struct {
    packets     chan Packet             // Proxy â†’ App Logic
    closeConns  chan net.Conn           // é—œé–‰é€£ç·šé€šçŸ¥
    subscribers map[string][]net.Conn   // topic â†’ è¨‚é–±è€…åˆ—è¡¨
    subscriberMu sync.Mutex             // ä¿è­· subscribers map
}
```

## æ™‚åºåœ– (Sequence Diagram)

```
Publisher         Proxy              Application         Subscriber A      Subscriber B
                Goroutine            Logic              (sports)          (sports)
    â”‚                â”‚                  â”‚                    â”‚                 â”‚
    â”‚  Connect       â”‚                  â”‚                    â”‚                 â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                    â”‚                 â”‚
    â”‚                â”‚                  â”‚                    â”‚                 â”‚
    â”‚ PUBLISH|sports|Goal!              â”‚                    â”‚                 â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                    â”‚                 â”‚
    â”‚                â”‚ parsePacket()    â”‚                    â”‚                 â”‚
    â”‚                â”œâ”€â”€â”               â”‚                    â”‚                 â”‚
    â”‚                â”‚<â”€â”˜               â”‚                    â”‚                 â”‚
    â”‚                â”‚                  â”‚                    â”‚                 â”‚
    â”‚                â”‚  packets <- pkt  â”‚                    â”‚                 â”‚
    â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                 â”‚
    â”‚                â”‚                  â”‚ handlePublish()    â”‚                 â”‚
    â”‚                â”‚                  â”œâ”€â”€â”                 â”‚                 â”‚
    â”‚                â”‚                  â”‚  â”‚ Get subscribers â”‚                 â”‚
    â”‚                â”‚                  â”‚  â”‚ for "sports"    â”‚                 â”‚
    â”‚                â”‚                  â”‚<â”€â”˜                 â”‚                 â”‚
    â”‚                â”‚                  â”‚                    â”‚                 â”‚
    â”‚                â”‚                  â”‚ Forward: "Goal!\n" â”‚                 â”‚
    â”‚                â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                 â”‚
    â”‚                â”‚                  â”‚                    â”‚                 â”‚
    â”‚                â”‚                  â”‚ Forward: "Goal!\n" â”‚                 â”‚
    â”‚                â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                â”‚                  â”‚                    â”‚                 â”‚
    â”‚ Close          â”‚                  â”‚ Close Publisher    â”‚                 â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                 â”‚
    â”‚                â”‚                  â”‚                    â”‚                 â”‚
```

## Reactive æ¨¡å¼ç‰¹é» (Reactive Pattern Features)

### 1. **éé˜»å¡ I/O (Non-blocking I/O)**
```go
// Proxy ä½¿ç”¨çŸ­æš«çš„ timeout é€²è¡Œè¼ªè©¢ï¼Œä¸æœƒé˜»å¡
b.listener.SetDeadline(time.Now().Add(1 * time.Millisecond))
conn.SetReadDeadline(time.Now().Add(1 * time.Millisecond))
```

### 2. **å–®ä¸€åŸ·è¡Œç·’æ‡‰ç”¨é‚è¼¯ (Single-threaded Application Logic)**
```go
// Application Logic goroutine å¾ channel æ¥æ”¶äº‹ä»¶
// ç¢ºä¿ç‹€æ…‹ç®¡ç†ä¸éœ€è¦è¤‡é›œçš„é–æ©Ÿåˆ¶
for {
    select {
    case packet := <-b.packets:      // è™•ç†è¨Šæ¯
    case conn := <-b.closeConns:     // è™•ç†é—œé–‰
    }
}
```

### 3. **Channel-based è¨Šæ¯å‚³é (Channel-based Messaging)**
```go
packets     chan Packet     // Proxy â†’ Application Logic
closeConns  chan net.Conn   // é€£ç·šç®¡ç†é€šçŸ¥
```

## è¨Šæ¯æ ¼å¼ (Message Format)

```
è¨‚é–± (Subscribe):   SUBSCRIBE|<topic>\n
ç™¼å¸ƒ (Publish):     PUBLISH|<topic>|<message>\n

ç¯„ä¾‹ (Examples):
SUBSCRIBE|sports\n
PUBLISH|sports|Goal scored!\n
PUBLISH|tech|New feature released!\n
```

## æ•ˆèƒ½ç‰¹æ€§ (Performance Characteristics)

1. **ä½å»¶é²**: è¨Šæ¯é€šé channel å¿«é€Ÿè·¯ç”±ï¼Œç„¡éœ€è¤‡é›œçš„é–ç«¶çˆ­
2. **å¯æ“´å±•æ€§**: å–®ä¸€ proxy goroutine è™•ç†æ‰€æœ‰ I/Oï¼Œapplication logic å°ˆæ³¨æ–¼è·¯ç”±
3. **å®¹éŒ¯æ€§**: Publisher ç™¼é€å¾Œç«‹å³æ–·ç·šï¼Œä¸å½±éŸ¿ subscriber æ¥æ”¶
4. **ä¸»é¡Œéš”é›¢**: ä¸åŒä¸»é¡Œçš„è¨‚é–±è€…äº’ä¸å¹²æ“¾

## é—œéµç¨‹å¼ç¢¼è¨»è§£ (Key Code Annotations)

### handlePublish - è¨Šæ¯è½‰ç™¼çš„æ ¸å¿ƒå‡½æ•¸
```go
func (b *Broker) handlePublish(packet Packet) {
    // Step 1: å®‰å…¨åœ°è®€å–è¨‚é–±è€…åˆ—è¡¨
    b.subscriberMu.Lock()
    subscribers := b.subscribers[packet.topic]
    b.subscriberMu.Unlock()

    // Step 2: è½‰ç™¼è¨Šæ¯çµ¦æ‰€æœ‰è¨‚é–±è€…
    for _, conn := range subscribers {
        message := fmt.Sprintf("%s\n", packet.payload)
        _, err := conn.Write([]byte(message))  // â† å¯¦éš›çš„è¨Šæ¯è½‰ç™¼
        if err != nil {
            b.closeConns <- conn  // éŒ¯èª¤æ™‚é€šçŸ¥æ¸…ç†
        }
    }

    // Step 3: é—œé–‰ç™¼å¸ƒè€…é€£ç·šï¼ˆç™¼å¸ƒå¾Œå³æ–·ç·šï¼‰
    packet.conn.Close()
}
```

é€™å€‹è¨­è¨ˆç¢ºä¿è¨Šæ¯è½‰ç™¼æ˜¯ï¼š
- **å¿«é€Ÿ**: ç›´æ¥å¯«å…¥ TCP é€£ç·š
- **å¯é **: éŒ¯èª¤è™•ç†å’Œè‡ªå‹•æ¸…ç†
- **éé˜»å¡**: Application logic åœ¨å–®ä¸€ goroutine ä¸­é †åºè™•ç†
